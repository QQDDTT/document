# C# 委托（Delegate）

- 在 C# 中，委托（Delegate） 是一种类型安全的函数指针，它允许将方法作为参数传递给其他方法。
- C# 中的委托（Delegate）类似于 C 或 C++ 中函数的指针。
- 委托（Delegate） 是存有对某个方法的引用的一种引用类型变量，引用可在运行时被改变。
- 委托在 C# 中非常常见，用于事件处理、回调函数、LINQ 等操作。
- 所有的委托（Delegate）都派生自 System.Delegate 类。

## 声明委托（Delegate）

```csharp
public delegate <return type> <delegate-name> <parameter list>
```

## 实例化委托（Delegate）

- 一旦声明了委托类型，委托对象必须使用 new 关键字来创建，且与一个特定的方法有关。

```csharp
using System;

delegate int NumberChanger(int n);
namespace DelegateAppl
{
   class TestDelegate
   {
      static int num = 10;
      public static int AddNum(int p)
      {
         num += p;
         return num;
      }

      public static int MultNum(int q)
      {
         num *= q;
         return num;
      }
      public static int getNum()
      {
         return num;
      }

      static void Main(string[] args)
      {
         // 创建委托实例
         NumberChanger nc1 = new NumberChanger(AddNum);
         NumberChanger nc2 = new NumberChanger(MultNum);
         // 使用委托对象调用方法
         nc1(25);
         Console.WriteLine("Value of Num: {0}", getNum());
         nc2(5);
         Console.WriteLine("Value of Num: {0}", getNum());
         Console.ReadKey();
      }
   }
}
```

## 委托的多播（Multicasting of a Delegate）

- 委托对象可使用 '+' 运算符进行合并。

- '-' 运算符可用于从合并的委托中移除组件委托。 

```csharp
using System;

delegate int NumberChanger(int n);
namespace DelegateAppl
{
   class TestDelegate
   {
      static int num = 10;
      public static int AddNum(int p)
      {
         num += p;
         return num;
      }

      public static int MultNum(int q)
      {
         num *= q;
         return num;
      }
      public static int getNum()
      {
         return num;
      }

      static void Main(string[] args)
      {
         // 创建委托实例
         NumberChanger nc;
         NumberChanger nc1 = new NumberChanger(AddNum);
         NumberChanger nc2 = new NumberChanger(MultNum);
         nc = nc1;
         nc += nc2;
         // 调用多播
         nc(5);
         Console.WriteLine("Value of Num: {0}", getNum());
         Console.ReadKey();
      }
   }
}
```

## 移除委托

- 可以通过 -= 运算符将该方法从委托链中移除

```csharp
public class Program
{
    public delegate void PrintMessage(string message);

    public static void PrintUpperCase(string message)
    {
        Console.WriteLine(message.ToUpper());
    }

    public static void PrintLowerCase(string message)
    {
        Console.WriteLine(message.ToLower());
    }

    public static void Main()
    {
        PrintMessage print = PrintUpperCase;
        print += PrintLowerCase;

        // 移除 PrintLowerCase 方法
        print -= PrintLowerCase;

        // 调用委托（只会调用 PrintUpperCase）
        print("Hello, C#");  // 输出: HELLO, C#
    }
}
```

## 委托和事件

- 委托常常与事件（Event）一起使用，事件是一种特殊类型的委托，用于发布和订阅机制

```csharp
public class Button
{
    // 定义一个事件
    public event EventHandler Click;

    // 引发事件的方法
    public void OnClick()
    {
        if (Click != null)
        {
            Click(this, EventArgs.Empty);  // 调用事件
        }
    }
}
public class Program
{
    public static void Main()
    {
        Button button = new Button();
        
        // 订阅事件
        button.Click += Button_Click;

        // 引发事件
        button.OnClick();  // 输出 "Button clicked!"
    }

    private static void Button_Click(object sender, EventArgs e)
    {
        Console.WriteLine("Button clicked!");
    }
}
```

## 委托的类型

- C# 提供了几种常见的委托类型：

1. Action

    - Action：代表不返回值的方法。可以接受最多 16 个参数。

```csharp
Action<string> printMessage = Console.WriteLine;
printMessage("Hello");
```

2. Func

    - Func：代表有返回值的方法。最多接受 16 个参数，第一个参数是输入参数，最后一个参数是返回值类型。

```csharp
Func<int, int, int> add = (x, y) => x + y;
Console.WriteLine(add(3, 4));  // 输出 7
```

3. Predicate

    - Predicate：代表返回 bool 值的方法，通常用于条件判断。

```csharp
Predicate<int> isEven = x => x % 2 == 0;
Console.WriteLine(isEven(4));  // 输出 True
```
